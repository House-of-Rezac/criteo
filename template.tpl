___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": ["REMARKETING", "ANALYTICS", "ADVERTISING"],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Criteo",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Implementation of tracking code for Criteo\n@author House of Rezac\n@web https://www.houseofrezac.com/gtm\n@version 2020-07-09",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "Partner ID",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Partner ID available in Criteo administration"
  },
  {
    "type": "TEXT",
    "name": "userEmail",
    "displayName": "User Email",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "pageType",
    "displayName": "Page Type",
    "simpleValueType": true,
    "help": "Possible values are described in specification"
  },
  {
    "type": "TEXT",
    "name": "deviceType",
    "displayName": "Device Type",
    "simpleValueType": true,
    "help": "Valid values are mobile, tablet and desktop",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^(|m|t|d|mobile|tablet|desktop)$"
        ],
        "errorMessage": "Can be only mobile, tablet, desktop"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "currencyCode",
    "displayName": "Currency Code",
    "simpleValueType": true,
    "help": "Currency code according ISO 4217, e.g. EUR, USD, CZK etc."
  },
  {
    "type": "SELECT",
    "name": "products",
    "displayName": "Products",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "help": "Products relevant for given page"
  },
  {
    "type": "SELECT",
    "name": "transactionId",
    "displayName": "Transaction ID",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "checkoutStep",
    "displayName": "Checkout Step",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "help": "On checkout step 1 (or cart step) is called event \"viewBasket\""
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const createQueue = require('createQueue');
const makeNumber = require('makeNumber');
const makeInteger = require('makeInteger');
const makeString = require('makeString');

log('Criteo data:', data);
const criteoPush = createQueue('criteo_q');
const products = data.products || [];
const device = (data.deviceType || '').substring(0, 1);
const push = function(params) {
  criteoPush(params);
  log('Criteo Push:', params);
};


// -------- GENERIC DATA --------
push({ event: "setAccount", account: data.id });

if (data.userEmail) {
  push({ event: "setEmail", email: data.userEmail });
}

if (device) {
  push({ event: "setSiteType", type: device });
}




// -------- PAGE SPECIFIC DATA --------
const getProducts = function() {
  return products.map(function(product){
    return {
    	'id': makeString(product.id),
      	'price': makeNumber(product.price),
      	'quantity': makeInteger(product.quantity)
    };
  });
};


let pageType = data.pageType ? data.pageType.toLowerCase() : '';
pageType = pageType.split('.').slice(0,2).join('.');
switch (pageType) {
  case 'home':
  case 'homepage':
    push({
      'event': "viewHome"
    });
    break;

  case 'product':
  case 'detail':
  case 'product.detail':
    push({
      'event': "viewItem",
      'item': data.products && data.products.length ? data.products[0].id : null
    });
    break;
    
  case 'category':
  case 'list':
  case 'product.list':
  case 'searchresults':
    push({
      'event': "viewList",
      'item': products.slice(0,3).map(function(product){
        return product.id;
      })
    });
    break;
    
    
  case 'cart':
    push({
      'event': "viewBasket",
      'currency': data.currencyCode,
      'item': getProducts()
    });
    break;
  case 'checkout':
    if (data.checkoutStep == 1) {
      push({
        'event': "viewBasket",
        'currency': data.currencyCode,
        'item': getProducts()
      });
    }
    break;
    
    
  case 'purchase':
    push({
      'event': "trackTransaction",
      'id': data.transactionId,
      'currency': data.currencyCode,
      'item': getProducts()
    });
    break;
}

injectScript('https://static.criteo.net/js/ld/ld.js', data.gtmOnSuccess, data.gtmOnFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://static.criteo.net/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "criteo_q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test run
  code: |-
    const mockData = {
      id: 1111,
      pageType: 'home',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK'
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalled();
- name: Test email was added
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'home',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK'
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'setEmail') {
          exp = param.email === 'foo@bar.com';
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Test device was added
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'home',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK'
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'setSiteType') {
          exp = param.type === 'm';
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Page Specific - Homepage
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'home',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK'
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'viewHome') {
          exp = true;
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Page Specific - Product Detail
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'product.detail',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK',
      products: [{
        'id': 123,
        'name': 'T-Shirt',
        'brand': 'Google',
        'category': 'Clothes'
      }]
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'viewItem') {
          assertThat(param.item).isEqualTo(123);
          exp = true;
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Page Specific - List
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'product.list.books',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK',
      products: [{
        'id': 1,
        'name': 'A',
        'brand': 'Google'
      },{
        'id': 2,
        'name': 'B',
        'brand': 'Google'
      },{
        'id': 3,
        'name': 'C',
        'brand': 'Google'
      },{
        'id': 4,
        'name': 'D',
        'brand': 'Google'
      },{
        'id': 5,
        'name': 'E',
        'brand': 'Google'
      }]
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'viewList') {
          assertThat(param.item).isEqualTo([1,2,3]);
          exp = true;
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Page Specific - Cart
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'checkout',
      userEmail: 'foo@bar.com',
      currencyCode: 'CZK',
      checkoutStep: 1,
      products: [{
        'id': 1,
        'name': 'A',
        'quantity': 1,
        'price': 10.90
      },{
        'id': '2',
        'name': 'B',
        'quantity': '2',
        'price': '20.90'
      }]
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'viewBasket') {
          assertThat(param.item).isEqualTo([{
            'id': '1',
            'price': 10.90,
            'quantity': 1
          },{
            'id': '2',
            'price': 20.90,
            'quantity': 2
          }]);
          exp = true;
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();
- name: Page Specific - Transaction
  code: |-
    let exp = false;
    const mockData = {
      id: 1111,
      pageType: 'purchase',
      userEmail: 'foo@bar.com',
      deviceType: 'mobile',
      currencyCode: 'CZK',
      transactionId: 'T09876',
      products: [{
        'id': 123,
        'name': 'T-Shirt',
        'brand': 'Google',
        'category': 'Clothes',
        'quantity': 1,
        'price': 99.90
      }, {
        'id': 456,
        'name': 'Trousers',
        'brand': 'Microsoft',
        'category': 'Clothes',
        'quantity': 2,
        'price': 150.00
      }]
    };
    mock('createQueue', function() {
      return (param) => {
        if (param && param.event && param.event === 'trackTransaction') {
          assertThat(param.id).isEqualTo('T09876');
          assertThat(param.currency).isEqualTo('CZK');
          assertThat(param.item).isEqualTo([{'id':'123','price':99.90,'quantity':1}, {'id':'456','price':150.00,'quantity':2}]);
          exp = true;
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);
    assertThat(exp).isTrue();


___NOTES___

Created on 20. 7. 2020 14:33:16


